# Supfile for ajournal
---
version: 0.4


networks: #Groups of hosts
  dev:
    env:
      AJBUILD: DEVEL
    hosts:
      - localhost
  release:
    env:
      AJBUILD: RELEASE
      GOOS: linux
      GOARCH: amd64
    hosts:
      - jzs@ajournal.dk:999

commands:
  clean:
    desc: Clean dist folder
    local: rm -rf dist

  dist: # We always build on local machine
    desc: Build a version that can be distributed
    local: ./scripts/dist.sh 

  upload:
    desc: Upload
    upload:
      - src: ./dist
        dst: /tmp/

  copy-bin:
    desc: Copy binary
    run: cp /tmp/dist/ajournal /usr/local/bin/ajournal

  copy-www:
    desc: Copy www-data
    run: cp -r /tmp/dist/www/ /var/www/ajournal/

  restart-service:
    desc: Restart systemd service
    run: sudo systemctl restart ajournal.service

  start-service:
    desc: Start systemd service
    run: sudo systemctl start ajournal.service

  stop-service:
    desc: Stop systemd service
    run: sudo systemctl stop ajournal.service

  migrate-up:
    desc: Run database migration tool up
    run: goose -env release -path /tmp/dist/db up

  bash:
    desc: Interactive bash script
    stdin: true
    run: bash

targets:
  rebuild:
    - clean
    - dist

  deploy:
    - clean
    - dist
    - upload
    - copy-www
    - stop-service
    - copy-bin
    - start-service
